<Page x:Class="kanzeed.Pages.ManageUsersPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Title="Управление пользователями"
      Background="#F8F9FA"
      xmlns:sys="clr-namespace:System;assembly=mscorlib">

    <Page.Resources>
        <Style x:Key="PrimaryButtonStyle" TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="Background" Value="#4361EE"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Height" Value="34"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="12,0"/>
            <Setter Property="Margin" Value="4,0,4,0"/>
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#4361EE"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#4361EE"/>
            <Setter Property="Height" Value="34"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="10,0"/>
            <Setter Property="Margin" Value="4,0,4,0"/>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="👥" FontSize="20" Margin="0,0,8,0"/>
            <StackPanel>
                <TextBlock Text="Пользователи" FontSize="20" FontWeight="Bold" Foreground="#333"/>
                <TextBlock Text="Просмотр и управление пользователями (только администратор)" FontSize="12" Foreground="#666"/>
            </StackPanel>
        </StackPanel>

        <!-- Controls: поиск, кнопки -->
        <StackPanel Orientation="Horizontal" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,0,12">
            <Border Background="#FFF" CornerRadius="6" Padding="6" BorderBrush="#EEE" BorderThickness="1" VerticalAlignment="Center">
                <Grid>
                    <TextBox x:Name="SearchBox" Width="320" Height="28" VerticalContentAlignment="Center" Padding="6,0" TextChanged="SearchBox_TextChanged"/>
                </Grid>
            </Border>

            <Button Style="{StaticResource PrimaryButtonStyle}" Click="RefreshButton_Click" Margin="12,0,0,0">Обновить</Button>
            <Button Style="{StaticResource SecondaryButtonStyle}" Click="BackButton_Click">Назад</Button>
        </StackPanel>

        <!-- DataGrid -->
        <Border Grid.Row="2" Background="White" CornerRadius="8" Padding="12" BorderBrush="#EEE" BorderThickness="1">
            <DataGrid x:Name="UsersGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                      IsReadOnly="False" SelectionMode="Single" RowHeight="36">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="70" IsReadOnly="True"/>
                    <DataGridCheckBoxColumn Header="Сотрудник" Binding="{Binding IsEmployee}" Width="90" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Имя" Binding="{Binding FullName}" Width="220" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="220" IsReadOnly="True"/>
                    <DataGridTemplateColumn Header="Роль" Width="180">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RoleName}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding DataContext.RolesList, RelativeSource={RelativeSource AncestorType=Page}}"
                                          DisplayMemberPath="role_name"
                                          SelectedValuePath="role_id"
                                          SelectedValue="{Binding RoleId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Действия" Width="160">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Content="Сохранить" Click="SaveRole_Click" Tag="{Binding}" Style="{StaticResource PrimaryButtonStyle}"/>
                                    <Button Content="Профиль" Click="OpenProfile_Click" Tag="{Binding}" Style="{StaticResource SecondaryButtonStyle}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- Bottom helper -->
        <TextBlock Grid.Row="3" Text="Изменение роли сохранит значение в таблице CUSTOMERS или EMPLOYEES. Удаление и другие операции доступны в админ-панели." 
                   FontSize="12" Foreground="#777" Margin="4,10,0,0"/>
    </Grid>
</Page>
